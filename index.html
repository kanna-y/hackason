<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŠãã™ã‚Šãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: #f0f8ff;
    }

    #register, #chat {
      width: 100%;
      max-width: 400px;
      text-align: center;
      background: white;
      padding: 2rem 1rem;
      border-radius: 1rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    input, button {
      margin: 0.5rem;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 0.5rem;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #btnTaken {
      background-color: #4CAF50;
      color: white;
    }

    #recv {
      text-align: left;
      margin-top: 1rem;
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 0.5rem;
      background: #f9f9f9;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="register">
    <h2>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <input id="usernameInput" placeholder="ãŸã‚ã†"><br>
    <button id="btnregister">å…¥å®¤</button>
  </div>

  <div id="chat" style="display:none">
    <h1>ãŠãã™ã‚Šãƒã‚¤ãƒ³ãƒ€ãƒ¼</h1>
    <input id="room" placeholder="room name">
    <button id="btnenter">enter</button><br><br>

    <main id="main" style="display:none">
      <input id="mes">
      <button id="btn">send</button>
      <button id="btnTaken">ã®ã‚“ã ã‚ˆ</button>
      <div id="recv"></div>
    </main>
  </div>

  <script type="module">
    import { CBOR } from "https://js.sabae.cc/CBOR.js";
    import { blob2bin } from "./util.js";

    let username = "";

    const insertChild = (parent, c) => {
      if (parent.firstChild) {
        parent.insertBefore(c, parent.firstChild);
      } else {
        parent.appendChild(c);
      }
    };

    const insertComment = (parent, message) => {
      const now = new Date();
      const time = now.toLocaleString();
      const div = document.createElement("div");
      div.textContent = `${time} > ${message}`;
      insertChild(parent, div);
    };

    btnregister.onclick = () => {
      const name = usernameInput.value.trim();
      if (!name) {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
        return;
      }
      username = name;
      register.style.display = "none";
      chat.style.display = "block";
    };

    btnenter.onclick = () => {
      main.style.display = "block";
      const roomname = room.value || "default";
      const host = location.hostname;
      const port = location.port ? ":" + location.port : "";
      const protocol = location.protocol === "https:" ? "wss:" : "ws:";
      const address = `${protocol}//${host}${port}/${roomname}/ws`;
      const socket = new WebSocket(address);

      socket.onmessage = async (msg) => {
        const bin = await blob2bin(msg.data);
        const data = CBOR.decode(bin);
        insertComment(recv, data.data);
        // ä¿å­˜ï¼šã™ã¹ã¦ã®å±¥æ­´ã‚’ localStorage ã«ä¿å­˜
        const history = JSON.parse(localStorage.getItem("history") || "[]");
        history.push({ time: new Date().toLocaleString(), text: data.data });
        localStorage.setItem("history", JSON.stringify(history));
      };

      btn.onclick = () => {
        const message = `${username}: ${mes.value}`;
        socket.send(message);
        mes.value = "";
      };

      btnTaken.onclick = () => {
        const message = `${username}: ã®ã¿ã¾ã—ãŸğŸ’Š`;
        socket.send(message);
      };

      // åˆæœŸè¡¨ç¤ºï¼šä¿å­˜æ¸ˆã¿ã®å±¥æ­´è¡¨ç¤º
      const saved = JSON.parse(localStorage.getItem("history") || "[]");
      for (const item of saved) {
        insertComment(recv, item.text);
      }
    };
  </script>
</body>
</html>
